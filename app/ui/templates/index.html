{% extends "base.html" %}

{% block title %}메인 대시보드 - 문서 처리 파이프라인{% endblock %}

{% block content %}
<div class="row">
    <!-- 현재 모드 상태 -->
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    현재 처리 모드
                </h5>
            </div>
            <div class="card-body">
                <div id="mode-status" class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>모드 정보를 로딩 중...</span>
                </div>
                <div id="mode-details" class="mt-3" style="display: none;">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>자동 패치:</strong>
                            <span id="auto-patch-status" class="badge"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>자동 진행:</strong>
                            <span id="auto-advance-status" class="badge"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Batch API:</strong>
                            <span id="batch-api-status" class="badge"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>품질 게이트:</strong>
                            <span id="quality-gates" class="small text-muted"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 규칙 전용 처리 모드 -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    규칙 전용 처리
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    완성된 기본규칙만으로 모든 판례를 전처리합니다.
                    <br><small class="text-muted">AI 평가 없음, 빠른 처리</small>
                </p>
                
                <!-- 테스트 섹션 -->
                <div class="mb-3">
                    <h6 class="fw-bold">1. 테스트 실행</h6>
                    <div class="input-group mb-2">
                        <input type="number" id="test-limit" class="form-control" value="10" min="1" max="100">
                        <button class="btn btn-outline-success" id="test-rule-processing" onclick="console.log('HTML onclick 호출됨'); simpleTest(); return false;">
                            <i class="fas fa-flask me-1"></i>테스트
                        </button>
                    </div>
                    <div id="test-results" class="small text-muted" style="display: none;"></div>
                </div>

                <!-- 전체 처리 섹션 -->
                <div class="mb-3">
                    <h6 class="fw-bold">2. 전체 처리</h6>
                    <div class="input-group mb-2">
                        <span class="input-group-text">배치 크기</span>
                        <input type="number" id="batch-size" class="form-control" value="100" min="10" max="1000">
                        <button class="btn btn-success" id="start-rule-processing">
                            <i class="fas fa-play me-1"></i>시작
                        </button>
                    </div>
                </div>

                <!-- 진행 상황 -->
                <div id="rule-processing-status" style="display: none;">
                    <h6 class="fw-bold">진행 상황</h6>
                    <div class="progress mb-2">
                        <div id="rule-progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold" id="processed-count">0</div>
                            <small class="text-muted">처리 완료</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold" id="processing-rate">0/초</div>
                            <small class="text-muted">처리 속도</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 단건 점검 모드 -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-play-circle me-2"></i>
                    단건 점검 모드
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    케이스 1건 기준으로 전처리 → GPT-5 평가 → 규칙 자동 패치 → 재실행까지 안정적으로 순환하는지 확인합니다.
                </p>
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>목표:</strong> 연속 20건 합격 달성<br>
                        <strong>합격선:</strong> NRR≥0.92, FPR≥0.985, SS≥0.90, 토큰절감≥20%
                    </small>
                </div>
                <div class="d-grid">
                    <a href="/single-run" class="btn btn-primary">
                        <i class="fas fa-arrow-right me-1"></i>
                        단건 점검 시작
                    </a>
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col">
                        <div class="h6 mb-0" id="single-consecutive">-</div>
                        <small class="text-muted">연속 통과</small>
                    </div>
                    <div class="col">
                        <div class="h6 mb-0" id="single-ready">-</div>
                        <small class="text-muted">승급 준비</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 배치 개선 모드 -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-layer-group me-2"></i>
                    Batch API 반복 개선
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    층화 샘플(대량)로 규칙을 자동 반복 개선하여 규칙파일(DSL)을 대규모 검증으로 안정화합니다.
                </p>
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>진행:</strong> 200 → 1,000 → 5,000건 순으로 확대<br>
                        <strong>멈춤 조건:</strong> 2-3회 연속 유의미 개선 없음
                    </small>
                </div>
                <div class="d-grid">
                    <a href="/batch" class="btn btn-warning">
                        <i class="fas fa-arrow-right me-1"></i>
                        배치 개선 시작
                    </a>
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col">
                        <div class="h6 mb-0" id="batch-cycles">-</div>
                        <small class="text-muted">개선 사이클</small>
                    </div>
                    <div class="col">
                        <div class="h6 mb-0" id="batch-stable">-</div>
                        <small class="text-muted">규칙 안정</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 전량 처리 모드 -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>
                    전량 처리 (16만건)
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    충분히 테스트된 규칙파일로 전체 16만건을 처리합니다. 반드시 수동 버튼으로만 시작됩니다.
                </p>
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>전환 조건:</strong> 홀드아웃 합격 + 회귀 0 + 규칙 안정<br>
                        <strong>드라이런:</strong> 1% (1,600건) 성능 검증 후 진행
                    </small>
                </div>
                <div class="d-grid">
                    <a href="/full-processing" class="btn btn-success">
                        <i class="fas fa-arrow-right me-1"></i>
                        전량 처리 페이지
                    </a>
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col">
                        <div class="h6 mb-0" id="full-ready">-</div>
                        <small class="text-muted">준비 상태</small>
                    </div>
                    <div class="col">
                        <div class="h6 mb-0" id="full-progress">-</div>
                        <small class="text-muted">진행률</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 시스템 상태 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-heartbeat me-2"></i>
                    시스템 상태
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-microchip fa-2x text-primary"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="cpu-usage">-</div>
                                <small class="text-muted">CPU 사용률</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-memory fa-2x text-info"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="memory-usage">-</div>
                                <small class="text-muted">메모리 사용률</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-database fa-2x text-success"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="db-status">-</div>
                                <small class="text-muted">데이터베이스</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="alert-count">-</div>
                                <small class="text-muted">활성 알림</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 최근 활동 -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    최근 처리 결과
                </h5>
            </div>
            <div class="card-body">
                <div id="recent-results" class="list-group list-group-flush">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span class="ms-2">데이터 로딩 중...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    품질 지표 트렌드
                </h5>
            </div>
            <div class="card-body">
                <canvas id="quality-trend-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
console.log('✅ 인라인 JavaScript 시작');

// 테스트 함수 직접 정의
function simpleTest() {
    console.log('🎯 simpleTest 함수 호출됨!');
    alert('simpleTest 함수가 정상 작동합니다!');
    
    // 실제 테스트 함수 호출
    testRuleProcessing();
}

// 규칙 전용 처리 테스트
async function testRuleProcessing() {
    console.log('🧪 testRuleProcessing 함수 호출됨');
    
    const testButton = document.getElementById('test-rule-processing');
    const testLimit = document.getElementById('test-limit').value || 10;
    const testResults = document.getElementById('test-results');
    
    try {
        // 버튼 비활성화
        testButton.disabled = true;
        testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>테스트 중...';
        
        console.log('🔧 API 호출 시작:', `/api/process/rule-only/test?limit=${testLimit}`);
        
        const response = await fetch(`/api/process/rule-only/test?limit=${testLimit}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        console.log('✅ API 응답:', data);
        
        if (data.status === 'success') {
            const results = data.test_results;
            testResults.innerHTML = `
                <div class="alert alert-success">
                    <strong>✅ 테스트 완료</strong><br>
                    • 처리된 문서: ${results.processed_documents}개<br>
                    • 평균 압축률: ${results.average_reduction_rate}%<br>
                    • 적용된 규칙: ${results.total_rules_applied}개<br>
                    • 처리 시간: ${results.processing_time_ms}ms
                </div>
            `;
            testResults.style.display = 'block';
        } else {
            throw new Error(data.message || '테스트 실패');
        }
        
    } catch (error) {
        console.error('❌ 테스트 실패:', error);
        testResults.innerHTML = `
            <div class="alert alert-danger">
                <strong>❌ 테스트 실패</strong><br>
                ${error.message}<br>
                <small>콘솔에서 자세한 정보를 확인하세요.</small>
            </div>
        `;
        testResults.style.display = 'block';
    } finally {
        // 버튼 복구
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-flask me-1"></i>테스트';
    }
}

// 직접 API 테스트 함수
async function directApiTest() {
    const testLimit = document.getElementById('test-limit').value || 10;
    const testResults = document.getElementById('test-results');
    
    try {
        console.log('🔧 직접 API 호출 시작');
        
        const response = await fetch('/api/process/rule-only/test?limit=' + testLimit, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        console.log('✅ API 응답:', data);
        
        if (data.status === 'success') {
            const results = data.test_results;
            testResults.innerHTML = `
                <div class="alert alert-success">
                    <strong>✅ 테스트 완료</strong><br>
                    • 처리된 문서: ${results.processed_documents}개<br>
                    • 평균 압축률: ${results.average_reduction_rate}%<br>
                    • 적용된 규칙: ${results.total_rules_applied}개<br>
                    • 처리 시간: ${results.processing_time_ms}ms
                </div>
            `;
            testResults.style.display = 'block';
        } else {
            throw new Error(data.message || '테스트 실패');
        }
        
    } catch (error) {
        console.error('❌ API 테스트 실패:', error);
        testResults.innerHTML = `
            <div class="alert alert-danger">
                <strong>❌ 테스트 실패</strong><br>
                ${error.message}<br>
                <small>콘솔에서 자세한 정보를 확인하세요.</small>
            </div>
        `;
        testResults.style.display = 'block';
    }
}

// 전역에서 접근 가능하도록 설정
window.simpleTest = simpleTest;
window.directApiTest = directApiTest;

console.log('✅ 인라인 테스트 함수 정의 완료');
</script>

<!-- Dashboard JS 로드 -->
<script src="/static/js/dashboard.js"></script>
{% endblock %}
