{% extends "base.html" %}

{% block title %}ë©”ì¸ ëŒ€ì‹œë³´ë“œ - ë¬¸ì„œ ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸{% endblock %}

{% block content %}
<div class="row">
    <!-- í˜„ì¬ ëª¨ë“œ ìƒíƒœ -->
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    í˜„ì¬ ì²˜ë¦¬ ëª¨ë“œ
                </h5>
            </div>
            <div class="card-body">
                <div id="mode-status" class="d-flex align-items-center">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span>ëª¨ë“œ ì •ë³´ë¥¼ ë¡œë”© ì¤‘...</span>
                </div>
                <div id="mode-details" class="mt-3" style="display: none;">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>ìë™ íŒ¨ì¹˜:</strong>
                            <span id="auto-patch-status" class="badge"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>ìë™ ì§„í–‰:</strong>
                            <span id="auto-advance-status" class="badge"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>Batch API:</strong>
                            <span id="batch-api-status" class="badge"></span>
                        </div>
                        <div class="col-md-3">
                            <strong>í’ˆì§ˆ ê²Œì´íŠ¸:</strong>
                            <span id="quality-gates" class="small text-muted"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- ê·œì¹™ ì „ìš© ì²˜ë¦¬ ëª¨ë“œ -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    ê·œì¹™ ì „ìš© ì²˜ë¦¬
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    ì™„ì„±ëœ ê¸°ë³¸ê·œì¹™ë§Œìœ¼ë¡œ ëª¨ë“  íŒë¡€ë¥¼ ì „ì²˜ë¦¬í•©ë‹ˆë‹¤.
                    <br><small class="text-muted">AI í‰ê°€ ì—†ìŒ, ë¹ ë¥¸ ì²˜ë¦¬</small>
                </p>
                
                <!-- í…ŒìŠ¤íŠ¸ ì„¹ì…˜ -->
                <div class="mb-3">
                    <h6 class="fw-bold">1. í…ŒìŠ¤íŠ¸ ì‹¤í–‰</h6>
                    <div class="input-group mb-2">
                        <input type="number" id="test-limit" class="form-control" value="10" min="1" max="100">
                        <button class="btn btn-outline-success" id="test-rule-processing" onclick="console.log('HTML onclick í˜¸ì¶œë¨'); simpleTest(); return false;">
                            <i class="fas fa-flask me-1"></i>í…ŒìŠ¤íŠ¸
                        </button>
                    </div>
                    <div id="test-results" class="small text-muted" style="display: none;"></div>
                </div>

                <!-- ì „ì²´ ì²˜ë¦¬ ì„¹ì…˜ -->
                <div class="mb-3">
                    <h6 class="fw-bold">2. ì „ì²´ ì²˜ë¦¬</h6>
                    <div class="input-group mb-2">
                        <span class="input-group-text">ë°°ì¹˜ í¬ê¸°</span>
                        <input type="number" id="batch-size" class="form-control" value="100" min="10" max="1000">
                        <button class="btn btn-success" id="start-rule-processing">
                            <i class="fas fa-play me-1"></i>ì‹œì‘
                        </button>
                    </div>
                </div>

                <!-- ì§„í–‰ ìƒí™© -->
                <div id="rule-processing-status" style="display: none;">
                    <h6 class="fw-bold">ì§„í–‰ ìƒí™©</h6>
                    <div class="progress mb-2">
                        <div id="rule-progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold" id="processed-count">0</div>
                            <small class="text-muted">ì²˜ë¦¬ ì™„ë£Œ</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold" id="processing-rate">0/ì´ˆ</div>
                            <small class="text-muted">ì²˜ë¦¬ ì†ë„</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë‹¨ê±´ ì ê²€ ëª¨ë“œ -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-play-circle me-2"></i>
                    ë‹¨ê±´ ì ê²€ ëª¨ë“œ
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    ì¼€ì´ìŠ¤ 1ê±´ ê¸°ì¤€ìœ¼ë¡œ ì „ì²˜ë¦¬ â†’ GPT-5 í‰ê°€ â†’ ê·œì¹™ ìë™ íŒ¨ì¹˜ â†’ ì¬ì‹¤í–‰ê¹Œì§€ ì•ˆì •ì ìœ¼ë¡œ ìˆœí™˜í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.
                </p>
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>ëª©í‘œ:</strong> ì—°ì† 20ê±´ í•©ê²© ë‹¬ì„±<br>
                        <strong>í•©ê²©ì„ :</strong> NRRâ‰¥0.92, FPRâ‰¥0.985, SSâ‰¥0.90, í† í°ì ˆê°â‰¥20%
                    </small>
                </div>
                <div class="d-grid">
                    <a href="/single-run" class="btn btn-primary">
                        <i class="fas fa-arrow-right me-1"></i>
                        ë‹¨ê±´ ì ê²€ ì‹œì‘
                    </a>
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col">
                        <div class="h6 mb-0" id="single-consecutive">-</div>
                        <small class="text-muted">ì—°ì† í†µê³¼</small>
                    </div>
                    <div class="col">
                        <div class="h6 mb-0" id="single-ready">-</div>
                        <small class="text-muted">ìŠ¹ê¸‰ ì¤€ë¹„</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ë°°ì¹˜ ê°œì„  ëª¨ë“œ -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">
                    <i class="fas fa-layer-group me-2"></i>
                    Batch API ë°˜ë³µ ê°œì„ 
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    ì¸µí™” ìƒ˜í”Œ(ëŒ€ëŸ‰)ë¡œ ê·œì¹™ì„ ìë™ ë°˜ë³µ ê°œì„ í•˜ì—¬ ê·œì¹™íŒŒì¼(DSL)ì„ ëŒ€ê·œëª¨ ê²€ì¦ìœ¼ë¡œ ì•ˆì •í™”í•©ë‹ˆë‹¤.
                </p>
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>ì§„í–‰:</strong> 200 â†’ 1,000 â†’ 5,000ê±´ ìˆœìœ¼ë¡œ í™•ëŒ€<br>
                        <strong>ë©ˆì¶¤ ì¡°ê±´:</strong> 2-3íšŒ ì—°ì† ìœ ì˜ë¯¸ ê°œì„  ì—†ìŒ
                    </small>
                </div>
                <div class="d-grid">
                    <a href="/batch" class="btn btn-warning">
                        <i class="fas fa-arrow-right me-1"></i>
                        ë°°ì¹˜ ê°œì„  ì‹œì‘
                    </a>
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col">
                        <div class="h6 mb-0" id="batch-cycles">-</div>
                        <small class="text-muted">ê°œì„  ì‚¬ì´í´</small>
                    </div>
                    <div class="col">
                        <div class="h6 mb-0" id="batch-stable">-</div>
                        <small class="text-muted">ê·œì¹™ ì•ˆì •</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì „ëŸ‰ ì²˜ë¦¬ ëª¨ë“œ -->
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-database me-2"></i>
                    ì „ëŸ‰ ì²˜ë¦¬ (16ë§Œê±´)
                </h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    ì¶©ë¶„íˆ í…ŒìŠ¤íŠ¸ëœ ê·œì¹™íŒŒì¼ë¡œ ì „ì²´ 16ë§Œê±´ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤. ë°˜ë“œì‹œ ìˆ˜ë™ ë²„íŠ¼ìœ¼ë¡œë§Œ ì‹œì‘ë©ë‹ˆë‹¤.
                </p>
                <div class="mb-3">
                    <small class="text-muted">
                        <strong>ì „í™˜ ì¡°ê±´:</strong> í™€ë“œì•„ì›ƒ í•©ê²© + íšŒê·€ 0 + ê·œì¹™ ì•ˆì •<br>
                        <strong>ë“œë¼ì´ëŸ°:</strong> 1% (1,600ê±´) ì„±ëŠ¥ ê²€ì¦ í›„ ì§„í–‰
                    </small>
                </div>
                <div class="d-grid">
                    <a href="/full-processing" class="btn btn-success">
                        <i class="fas fa-arrow-right me-1"></i>
                        ì „ëŸ‰ ì²˜ë¦¬ í˜ì´ì§€
                    </a>
                </div>
            </div>
            <div class="card-footer">
                <div class="row text-center">
                    <div class="col">
                        <div class="h6 mb-0" id="full-ready">-</div>
                        <small class="text-muted">ì¤€ë¹„ ìƒíƒœ</small>
                    </div>
                    <div class="col">
                        <div class="h6 mb-0" id="full-progress">-</div>
                        <small class="text-muted">ì§„í–‰ë¥ </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì‹œìŠ¤í…œ ìƒíƒœ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-heartbeat me-2"></i>
                    ì‹œìŠ¤í…œ ìƒíƒœ
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-microchip fa-2x text-primary"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="cpu-usage">-</div>
                                <small class="text-muted">CPU ì‚¬ìš©ë¥ </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-memory fa-2x text-info"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="memory-usage">-</div>
                                <small class="text-muted">ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ </small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-database fa-2x text-success"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="db-status">-</div>
                                <small class="text-muted">ë°ì´í„°ë² ì´ìŠ¤</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                            </div>
                            <div>
                                <div class="h6 mb-0" id="alert-count">-</div>
                                <small class="text-muted">í™œì„± ì•Œë¦¼</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìµœê·¼ í™œë™ -->
<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    ìµœê·¼ ì²˜ë¦¬ ê²°ê³¼
                </h5>
            </div>
            <div class="card-body">
                <div id="recent-results" class="list-group list-group-flush">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        <span class="ms-2">ë°ì´í„° ë¡œë”© ì¤‘...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    í’ˆì§ˆ ì§€í‘œ íŠ¸ë Œë“œ
                </h5>
            </div>
            <div class="card-body">
                <canvas id="quality-trend-chart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
console.log('âœ… ì¸ë¼ì¸ JavaScript ì‹œì‘');

// í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ì§ì ‘ ì •ì˜
function simpleTest() {
    console.log('ğŸ¯ simpleTest í•¨ìˆ˜ í˜¸ì¶œë¨!');
    alert('simpleTest í•¨ìˆ˜ê°€ ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤!');
    
    // ì‹¤ì œ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
    testRuleProcessing();
}

// ê·œì¹™ ì „ìš© ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
async function testRuleProcessing() {
    console.log('ğŸ§ª testRuleProcessing í•¨ìˆ˜ í˜¸ì¶œë¨');
    
    const testButton = document.getElementById('test-rule-processing');
    const testLimit = document.getElementById('test-limit').value || 10;
    const testResults = document.getElementById('test-results');
    
    try {
        // ë²„íŠ¼ ë¹„í™œì„±í™”
        testButton.disabled = true;
        testButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>í…ŒìŠ¤íŠ¸ ì¤‘...';
        
        console.log('ğŸ”§ API í˜¸ì¶œ ì‹œì‘:', `/api/process/rule-only/test?limit=${testLimit}`);
        
        const response = await fetch(`/api/process/rule-only/test?limit=${testLimit}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        console.log('âœ… API ì‘ë‹µ:', data);
        
        if (data.status === 'success') {
            const results = data.test_results;
            testResults.innerHTML = `
                <div class="alert alert-success">
                    <strong>âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ</strong><br>
                    â€¢ ì²˜ë¦¬ëœ ë¬¸ì„œ: ${results.processed_documents}ê°œ<br>
                    â€¢ í‰ê·  ì••ì¶•ë¥ : ${results.average_reduction_rate}%<br>
                    â€¢ ì ìš©ëœ ê·œì¹™: ${results.total_rules_applied}ê°œ<br>
                    â€¢ ì²˜ë¦¬ ì‹œê°„: ${results.processing_time_ms}ms
                </div>
            `;
            testResults.style.display = 'block';
        } else {
            throw new Error(data.message || 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        testResults.innerHTML = `
            <div class="alert alert-danger">
                <strong>âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</strong><br>
                ${error.message}<br>
                <small>ì½˜ì†”ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
            </div>
        `;
        testResults.style.display = 'block';
    } finally {
        // ë²„íŠ¼ ë³µêµ¬
        testButton.disabled = false;
        testButton.innerHTML = '<i class="fas fa-flask me-1"></i>í…ŒìŠ¤íŠ¸';
    }
}

// ì§ì ‘ API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
async function directApiTest() {
    const testLimit = document.getElementById('test-limit').value || 10;
    const testResults = document.getElementById('test-results');
    
    try {
        console.log('ğŸ”§ ì§ì ‘ API í˜¸ì¶œ ì‹œì‘');
        
        const response = await fetch('/api/process/rule-only/test?limit=' + testLimit, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        console.log('âœ… API ì‘ë‹µ:', data);
        
        if (data.status === 'success') {
            const results = data.test_results;
            testResults.innerHTML = `
                <div class="alert alert-success">
                    <strong>âœ… í…ŒìŠ¤íŠ¸ ì™„ë£Œ</strong><br>
                    â€¢ ì²˜ë¦¬ëœ ë¬¸ì„œ: ${results.processed_documents}ê°œ<br>
                    â€¢ í‰ê·  ì••ì¶•ë¥ : ${results.average_reduction_rate}%<br>
                    â€¢ ì ìš©ëœ ê·œì¹™: ${results.total_rules_applied}ê°œ<br>
                    â€¢ ì²˜ë¦¬ ì‹œê°„: ${results.processing_time_ms}ms
                </div>
            `;
            testResults.style.display = 'block';
        } else {
            throw new Error(data.message || 'í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨');
        }
        
    } catch (error) {
        console.error('âŒ API í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
        testResults.innerHTML = `
            <div class="alert alert-danger">
                <strong>âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨</strong><br>
                ${error.message}<br>
                <small>ì½˜ì†”ì—ì„œ ìì„¸í•œ ì •ë³´ë¥¼ í™•ì¸í•˜ì„¸ìš”.</small>
            </div>
        `;
        testResults.style.display = 'block';
    }
}

// ì „ì—­ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì •
window.simpleTest = simpleTest;
window.directApiTest = directApiTest;

console.log('âœ… ì¸ë¼ì¸ í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ ì •ì˜ ì™„ë£Œ');
</script>

<!-- Dashboard JS ë¡œë“œ -->
<script src="/static/js/dashboard.js"></script>
{% endblock %}
