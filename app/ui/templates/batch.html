{% extends "base.html" %}

{% block title %}배치 개선 모드 - 문서 처리 파이프라인{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h4 class="card-title mb-0">
                    <i class="fas fa-layer-group me-2"></i>
                    Batch API 반복 개선
                </h4>
            </div>
            <div class="card-body">
                <p class="mb-0">
                    층화 샘플(대량)로 규칙을 자동 반복 개선하여 "규칙파일(DSL)"을 대규모 검증으로 안정화합니다.
                </p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 배치 설정 및 시작 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    배치 설정
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="sample-size" class="form-label">샘플 크기</label>
                    <select class="form-select" id="sample-size">
                        <option value="10">10건 (테스트)</option>
                        <option value="200">200건 (시작)</option>
                        <option value="1000">1,000건 (중간)</option>
                        <option value="5000">5,000건 (대규모)</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">층화 기준</label>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="stratify-court" checked>
                        <label class="form-check-label" for="stratify-court">법원 유형</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="stratify-case" checked>
                        <label class="form-check-label" for="stratify-case">사건 유형</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="stratify-year" checked>
                        <label class="form-check-label" for="stratify-year">연도</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <button class="btn btn-warning w-100" id="start-batch-btn">
                        <i class="fas fa-play me-1"></i>
                        배치 개선 시작
                    </button>
                </div>
                
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>멈춤 조건:</strong><br>
                    2-3회 연속 유의미 개선 없음 & 회귀 0
                </div>
            </div>
        </div>
        
        <!-- 배치 통계 -->
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    배치 통계
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h4 mb-0 text-primary" id="improvement-cycles">0</div>
                        <small class="text-muted">개선 사이클</small>
                    </div>
                    <div class="col-6">
                        <div class="h4 mb-0" id="rules-stable">
                            <span class="badge bg-secondary">대기중</span>
                        </div>
                        <small class="text-muted">규칙 안정</small>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="h6 mb-1">현재 규칙 버전: <span id="current-version">v1.0.0</span></div>
                    <div class="h6 mb-1">예상 비용: <span id="estimated-cost">$0.00</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 배치 진행 상황 -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    배치 진행 상황
                </h5>
            </div>
            <div class="card-body">
                <div id="no-batch" class="text-center py-5 text-muted">
                    <i class="fas fa-info-circle fa-3x mb-3"></i>
                    <div>배치 개선을 시작하세요</div>
                </div>
                
                <div id="batch-progress" style="display: none;">
                    <!-- 배치 단계 -->
                    <div class="mb-4">
                        <h6>배치 사이클 단계</h6>
                        <div id="batch-steps">
                            <div class="batch-step" data-step="sample_selection">
                                <div class="batch-step-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">1. 샘플 선정</div>
                                    <small class="text-muted">층화 기준에 따른 샘플 선택</small>
                                </div>
                                <div class="batch-step-status">
                                    <span class="badge bg-secondary">대기</span>
                                </div>
                            </div>
                            
                            <div class="batch-step" data-step="preprocessing">
                                <div class="batch-step-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">2. 전처리 실행</div>
                                    <small class="text-muted">현재 규칙으로 전량 처리</small>
                                </div>
                                <div class="batch-step-status">
                                    <span class="badge bg-secondary">대기</span>
                                </div>
                            </div>
                            
                            <div class="batch-step" data-step="evaluation">
                                <div class="batch-step-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">3. Batch 평가</div>
                                    <small class="text-muted">GPT-5 Batch API로 품질 평가</small>
                                </div>
                                <div class="batch-step-status">
                                    <span class="badge bg-secondary">대기</span>
                                </div>
                            </div>
                            
                            <div class="batch-step" data-step="clustering">
                                <div class="batch-step-icon">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">4. 실패 클러스터링</div>
                                    <small class="text-muted">동일 패턴 묶기 및 분석</small>
                                </div>
                                <div class="batch-step-status">
                                    <span class="badge bg-secondary">대기</span>
                                </div>
                            </div>
                            
                            <div class="batch-step" data-step="patching">
                                <div class="batch-step-icon">
                                    <i class="fas fa-wrench"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">5. 자동 패치</div>
                                    <small class="text-muted">클러스터별 규칙 제안 적용</small>
                                </div>
                                <div class="batch-step-status">
                                    <span class="badge bg-secondary">대기</span>
                                </div>
                            </div>
                            
                            <div class="batch-step" data-step="gates">
                                <div class="batch-step-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">6. 안전 게이트</div>
                                    <small class="text-muted">유닛/회귀/홀드아웃 검사</small>
                                </div>
                                <div class="batch-step-status">
                                    <span class="badge bg-secondary">대기</span>
                                </div>
                            </div>
                            
                            <div class="batch-step" data-step="revalidation">
                                <div class="batch-step-icon">
                                    <i class="fas fa-check-double"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">7. 재검증</div>
                                    <small class="text-muted">동일 샘플로 개선 확인</small>
                                </div>
                                <div class="batch-step-status">
                                    <span class="badge bg-secondary">대기</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 진행률 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>전체 진행률</span>
                            <span id="overall-progress-text">0%</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" id="overall-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 실패 클러스터 -->
<div class="row mt-4" id="failure-clusters" style="display: none;">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    실패 클러스터 TOP 5
                </h5>
            </div>
            <div class="card-body">
                <div id="clusters-list">
                    <!-- 클러스터 목록이 여기에 표시됩니다 -->
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    배치 메트릭 요약
                </h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="h5 mb-0 text-success" id="batch-success-rate">-</div>
                        <small class="text-muted">성공률</small>
                    </div>
                    <div class="col-6">
                        <div class="h5 mb-0 text-info" id="batch-avg-time">-</div>
                        <small class="text-muted">평균 처리시간</small>
                    </div>
                </div>
                <div class="row text-center mt-3">
                    <div class="col-6">
                        <div class="h5 mb-0 text-warning" id="batch-cost">-</div>
                        <small class="text-muted">실제 비용</small>
                    </div>
                    <div class="col-6">
                        <div class="h5 mb-0 text-primary" id="batch-improvement">-</div>
                        <small class="text-muted">품질 개선</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 규칙 변경 이력 -->
<div class="row mt-4" id="rules-history" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-history me-2"></i>
                    규칙 변경 이력
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>버전</th>
                                <th>변경 내용</th>
                                <th>신뢰도</th>
                                <th>적용 시간</th>
                                <th>상태</th>
                            </tr>
                        </thead>
                        <tbody id="rules-history-body">
                            <!-- 규칙 변경 이력이 여기에 표시됩니다 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="/static/js/batch.js"></script>
{% endblock %}
